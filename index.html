<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>マップビューアー</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>

<style>
body { margin:0; display:flex; font-family:sans-serif; }
#sidebar { width:220px; padding:10px; border-right:1px solid #ccc; }
#sidebar button { width:100%; margin-bottom:4px; }
#sidebar button.active { background:#4CAF50; color:#fff; }
#legend { font-size:12px; margin-top:10px; }
#map { flex:1; height:100vh; }
#loading {
  position:absolute; inset:0;
  background:rgba(255,255,255,0.8);
  display:none; align-items:center; justify-content:center;
  font-size:20px; z-index:1000;
}
</style>
</head>

<body>
<div id="sidebar">
  <div id="menu"></div>
  <div id="legend"></div>
</div>
<div id="map"></div>
<div id="loading">読み込み中...</div>

<script>
const DEFAULT_CENTER = [35.68, 139.76];
const DEFAULT_ZOOM = 10;

const MANUAL_COLOR = 'red';
const colorPalette = [
  "blue","green","orange","purple","brown",
  "pink","cyan","yellow","gray","cadetblue"
];

let map;
let categoryClusters = {};
let categoryColors = {};

function getParam(name){
  return new URLSearchParams(location.search).get(name);
}

/* --------------------
   管理CSV読み込み
-------------------- */
async function loadManageCSV(url){
  const text = await fetch(url).then(r=>r.text());
  const rows = text.trim().split('\n').slice(1);
  return rows.map(r=>{
    const c = r.split(',');
    return {
      label: c[0],
      gid: c[1],
      hide: c[2]==='TRUE',
      zoom: Number(c[3])||null,
      lat: Number(c[4])||null,
      lng: Number(c[5])||null
    };
  });
}

/* --------------------
   メニュー生成
-------------------- */
function buildMenu(list){
  const menu = document.getElementById('menu');
  menu.innerHTML = '';

  list.filter(l=>!l.hide).forEach(item=>{
    const btn = document.createElement('button');
    btn.textContent = item.label;
    btn.onclick = ()=>{
      location.search = `?map_gid=${item.gid}`;
    };
    menu.appendChild(btn);
  });
}

function setActive(gid){
  document.querySelectorAll('#menu button').forEach(b=>{
    b.classList.toggle('active', b.textContent.includes(gid));
  });
}

/* --------------------
   MAP CSV 読み込み
-------------------- */
async function loadMapCSV(url){
  const text = await fetch(url).then(r=>r.text());
  const rows = text.trim().split('\n').slice(1);

  return rows.map(r=>{
    const c = r.split(',');
    return {
      labels:[c[0],c[1],c[2]].filter(Boolean),
      address:c[3],
      lat:Number(c[4]),
      lng:Number(c[5]),
      category:c[6]||'未分類',
      hidden:c[7]==='TRUE',
      note:c[8]
    };
  }).filter(d=>!d.hidden && d.lat && d.lng);
}

/* --------------------
   マップ描画
-------------------- */
function renderMap(data, center, zoom){
  if(map) map.remove();
  map = L.map('map').setView(center, zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  categoryClusters = {};
  categoryColors = {};

  data.forEach(d=>{
    if(d.category==='MANUAL'){
      categoryColors[d.category]=MANUAL_COLOR;
    }else if(!categoryColors[d.category]){
      const idx = Object.keys(categoryColors).filter(k=>k!=='MANUAL').length;
      categoryColors[d.category]=colorPalette[idx%colorPalette.length];
    }

    const icon = L.AwesomeMarkers.icon({
      icon:'circle',
      markerColor:categoryColors[d.category],
      prefix:'fa'
    });

    const popup = `
      ${d.labels.join(' / ')}<br>
      ${d.address}<br>
      ${d.category}<br>
      ${d.note||''}
    `;

    const marker = L.marker([d.lat,d.lng],{icon}).bindPopup(popup);

    if(!categoryClusters[d.category]){
      categoryClusters[d.category]=L.markerClusterGroup({
        iconCreateFunction: cluster=>{
          const color = categoryColors[d.category];
          return L.divIcon({
            html:`<div style="background:${color};border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;color:#fff">${cluster.getChildCount()}</div>`,
            iconSize:[30,30]
          });
        }
      });
      map.addLayer(categoryClusters[d.category]);
    }
    categoryClusters[d.category].addLayer(marker);
  });

  buildLegend();
}

function buildLegend(){
  const el = document.getElementById('legend');
  el.innerHTML = '<b>カテゴリ</b><br>';
  Object.entries(categoryColors).forEach(([k,v])=>{
    el.innerHTML += `<div><span style="color:${v}">●</span> ${k}</div>`;
  });
}

/* --------------------
   初期処理
-------------------- */
(async ()=>{
  document.getElementById('loading').style.display='flex';

  // ★ここを差し替える
  const manageCSV = 'MANAGE_CSV_URL';
  const mapCSVBase = 'MAP_CSV_BASE_URL?gid=';

  const manage = await loadManageCSV(manageCSV);
  buildMenu(manage);

  let gid = getParam('map_gid') ||
    manage.find(m=>!m.hide).gid;

  const info = manage.find(m=>m.gid===gid);

  const data = await loadMapCSV(mapCSVBase + gid);
  renderMap(
    data,
    info.lat&&info.lng ? [info.lat,info.lng] : DEFAULT_CENTER,
    info.zoom || DEFAULT_ZOOM
  );

  document.getElementById('loading').style.display='none';
})();
</script>
</body>
</html>
